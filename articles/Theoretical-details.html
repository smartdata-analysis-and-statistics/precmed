<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="precmed">
<title>Theoretical details • precmed</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Theoretical details">
<meta property="og:description" content="precmed">
<meta property="og:image" content="https://smartdata-analysis-and-statistics.github.io/precmed/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">precmed</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/precmed.html">Get started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/Count-examples.html">Example with count outcome</a>
    <a class="dropdown-item" href="../articles/Survival-examples.html">Example with survival outcome</a>
    <a class="dropdown-item" href="../articles/Additional-examples.html">Additional examples</a>
    <a class="dropdown-item" href="../articles/Theoretical-details.html">Theoretical details</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/smartdata-analysis-and-statistics/precmed">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Theoretical details</h1>
            <h3 data-toc-skip class="subtitle">Vignette 5 of 5</h3>
            
            <h4 data-toc-skip class="date">October 25, 2022</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/smartdata-analysis-and-statistics/precmed/blob/HEAD/vignettes/Theoretical-details.Rmd" class="external-link"><code>vignettes/Theoretical-details.Rmd</code></a></small>
      <div class="d-none name"><code>Theoretical-details.Rmd</code></div>
    </div>

    
    
<!-- badges: start -->
<p><a href="https://cran.r-project.org/package=precmed" class="external-link"><img src="https://www.r-pkg.org/badges/version/precmed" alt="CRAN_Status_Badge"></a> <a href="https://cran.r-project.org/package=precmed" class="external-link"><img src="https://cranlogs.r-pkg.org/badges/last-month/precmed" alt="metacran downloads"></a> <!-- badges: end --></p>
<h1>
precmed: Precision Medicine in R
</h1>
<p>A doubly robust precision medicine approach to estimate and validate conditional average treatment effects</p>
<div class="section level2">
<h2 id="theoretical-details---count-outcomes">Theoretical details - Count outcomes<a class="anchor" aria-label="anchor" href="#theoretical-details---count-outcomes"></a>
</h2>
<p>Assume that the following data are recorded for each of <span class="math inline">\(n\)</span> observations:</p>
<ul>
<li>
<span class="math inline">\(R\)</span> is a binary treatment taking value 0 or 1.</li>
<li>
<span class="math inline">\(\boldsymbol{X}\)</span> is a vector of <span class="math inline">\(p\)</span> baseline covariates.</li>
<li>
<span class="math inline">\(Y\)</span> is a count outcome.</li>
<li>
<span class="math inline">\(T\)</span> is the exposure time during which <span class="math inline">\(Y\)</span> is recorded. It can vary across observations.</li>
</ul>
<p>The objective is to estimate the ratio-based CATE score defined as</p>
<p><span class="math display">\[CATE(\boldsymbol{x})=\text{log}\left(\frac{\mathbb{E}[Y^{(1)}|\boldsymbol{X}=\boldsymbol{x},T=1]}{\mathbb{E}[Y^{(0)}|\boldsymbol{X}=\boldsymbol{x},T=1]}\right)\]</span> where <span class="math inline">\(Y^{(r)}\)</span> is the potential outcome if the patient received the treatment <span class="math inline">\(r \in \{0,1\}\)</span>. <span class="math inline">\(CATE(\boldsymbol{x})\)</span> is interpreted as the individualized log-rate ratio of treatment 1 over treatment 0 conditional on the baseline covariates.</p>
<p>The package offers 5 methods to estimate the CATE score: Poisson regression, negative binomial regression, boosting, two regressions, and contrast regression.</p>
<div class="section level3">
<h3 id="poisson">Poisson<a class="anchor" aria-label="anchor" href="#poisson"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Estimate the conditional mean outcome given baseline covariates and log-transformed exposure time as the offset separately in each treatment group (i.e., <span class="math inline">\(\text{log}(\mathbb{E}[Y^{(r)}|\boldsymbol{x},t])=\beta_r \boldsymbol{\tilde x}\)</span> for <span class="math inline">\(r \in \{0,1\}\)</span> where <span class="math inline">\(\boldsymbol{\tilde x}\)</span> is the <span class="math inline">\(x\)</span> with an intercept) with Poisson regression. Denote the prediction for one time unit as <span class="math inline">\(\hat Y^{(r)}(\boldsymbol{x},1)=\text{exp}(\hat \beta_r \boldsymbol{\tilde x})\)</span>.</p></li>
<li><p>The CATE score with Poisson is the plug-in estimator</p></li>
</ol>
<p><span class="math display">\[\hat{CATE}_{Poisson}(\boldsymbol{x})=\text{log}\left(\frac{\hat Y^{(1)}(\boldsymbol{x},1)}{\hat Y^{(0)}(\boldsymbol{x},1)}\right)\]</span></p>
</div>
<div class="section level3">
<h3 id="negative-binomial">Negative binomial<a class="anchor" aria-label="anchor" href="#negative-binomial"></a>
</h3>
<p>Follow the same step as in Poisson but replace Poisson regression with negative binomial regression in step 1.</p>
</div>
<div class="section level3">
<h3 id="boosting">Boosting<a class="anchor" aria-label="anchor" href="#boosting"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Estimate the conditional mean outcome given baseline covariates and log-transformed exposure time as the offset separately in each treatment group (i.e., <span class="math inline">\(\mathbb{E}[Y^{(r)}|\boldsymbol{x},t]\)</span> for <span class="math inline">\(r \in \{0,1\}\)</span>) with Poisson-based gradient boosting regression method. Denote the prediction for one time unit as <span class="math inline">\(\hat Y^{(r)}(\boldsymbol{x},1)\)</span>.</p>
<ul>
<li>The base learners are regression trees with depth specified with the argument <code>tree.depth</code> in <code><a href="../reference/catecvcount.html">catecvcount()</a></code> and <code><a href="../reference/catefitcount.html">catefitcount()</a></code>. Default is 2.</li>
<li>The number of trees in boosting is selected via cross-validation with a maximum number of trees specificed with the argument <code>n.trees</code> in <code><a href="../reference/catecvcount.html">catecvcount()</a></code> and <code><a href="../reference/catefitcount.html">catefitcount()</a></code>. Default is 200.</li>
</ul>
</li>
<li><p>The CATE score with boosting is the plug-in estimator</p></li>
</ol>
<p><span class="math display">\[\hat{CATE}_{boosting}(\boldsymbol{x})=\text{log}\left(\frac{\hat Y^{(1)}(\boldsymbol{x},1)}{\hat Y^{(0)}(\boldsymbol{x},1)}\right)\]</span></p>
</div>
<div class="section level3">
<h3 id="two-regressions">Two regressions<a class="anchor" aria-label="anchor" href="#two-regressions"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Randomly separate the data <span class="math inline">\(D\)</span> into <span class="math inline">\(K\)</span> (<code>Kfold</code>) non-overlapping parts of approximately equal sizes, <span class="math inline">\(D_1, \dots, D_K\)</span>.</p></li>
<li>
<p>For each fold <span class="math inline">\(k=1,\dots,K\)</span>, and separately by treatment group <span class="math inline">\(r \in \{0,1\}\)</span>:</p>
<p>2.1 Estimate the conditional mean outcome given baseline covariates and log-transformed exposure time as the offset with the Poisson-based gradient boosting regression method based on observations without the kth fold, <span class="math inline">\(D_{-k}\)</span>, and denote the prediction as <span class="math inline">\(\hat Y_{-k}^{(r)}(\boldsymbol{x},t)\)</span>. This is the initial nonparametric prediction of the potential outcome.</p>
<p>2.2 Estimate the PS based on <span class="math inline">\(D_{-k}\)</span>. Denote the estimated PS as <span class="math inline">\(\hat \pi_{-k}(\boldsymbol{x})\)</span> and estimate the weights <span class="math inline">\(\hat W(r)=r\frac{R}{\hat \pi_{-k}(\boldsymbol{x})}+(1-r)\frac{(1-R)}{1-\hat \pi_{-k}(\boldsymbol{x})}\)</span> with <span class="math inline">\(R\)</span> denoting the treatment received.</p>
<p>2.3 Solve the following weighted estimating equation by fitting a Poisson regression with <span class="math inline">\(Y\)</span> as the response, <span class="math inline">\(\text{log}(\hat Y^{(r)}(\boldsymbol{x},1))\)</span> and <span class="math inline">\(x\)</span> as the covariates, <span class="math inline">\(\text{log}(T)\)</span> as the offset, and <span class="math inline">\(\hat W(r)\)</span> as weight:</p>
<p><span class="math display">\[S(\alpha_{rk}, \boldsymbol{\gamma_{rk}})=\sum_{i \in D_{-k}} \hat W(r) \pmatrix{\text{log}\left(\hat Y^{(r)}(\boldsymbol{x},1)\right)\\\boldsymbol{\tilde x}}\left(Y - \text{exp}\left(\alpha_{rk}\text{log}\left(\hat Y^{(r)}(\boldsymbol{x},1)\right)+\boldsymbol{\gamma_{rk}^T\boldsymbol{\tilde x}}\right)\times T\right)=0\]</span></p>
<p>where <span class="math inline">\(i\)</span> denotes individual observations. Denote the roots by <span class="math inline">\((\hat \alpha_{rk}, \boldsymbol{\hat\gamma_{rk}})\)</span>.</p>
</li>
<li><p>Solve the following doubly robust estimating equation by fitting a Poisson regression with <span class="math inline">\(\text{exp}\left(\hat\alpha_{rk}\text{log}\left(\hat Y^{(r)}(\boldsymbol{x},1)\right)+\boldsymbol{\hat\gamma_{rk}^T\boldsymbol{\tilde x}}\right)\)</span> as the response, <span class="math inline">\(\boldsymbol{x}\)</span> as the covariates, and no offset or weight: <span class="math display">\[S(\boldsymbol{\beta_r})=\sum_{k=1}^K \sum_{i \in D_{-k}}\boldsymbol{\tilde x}\left(\text{exp}\left(\hat\alpha_{rk}\text{log}\left(\hat Y^{(r)}(\boldsymbol{x},1)\right)+\boldsymbol{\hat\gamma_{rk}^T\boldsymbol{\tilde x}}\right)-\text{exp}(\boldsymbol{\beta_r^T\tilde x})\right)=0\]</span> Denote the estimator as <span class="math inline">\(\boldsymbol{\hat \beta_r}\)</span>.</p></li>
<li><p>Repeat steps 1-3 with <span class="math inline">\(B\)</span> bootstrap samples and denote the estimator <span class="math inline">\(\boldsymbol{\hat \beta_{rb}}\)</span> in the <span class="math inline">\(b\)</span> sample. The final estimator <span class="math inline">\(\boldsymbol{\hat \beta_r}\)</span> is the mean of the <span class="math inline">\(\boldsymbol{\hat \beta_{rb}}\)</span>.</p></li>
<li><p>The CATE score with two regressions is</p></li>
</ol>
<p><span class="math display">\[\hat{CATE}_{tworeg}(\boldsymbol{x})=(\boldsymbol{\hat \beta_1} - \boldsymbol{\hat \beta_0})^T\boldsymbol{\tilde x}\]</span></p>
</div>
<div class="section level3">
<h3 id="contrast-regression">Contrast regression<a class="anchor" aria-label="anchor" href="#contrast-regression"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Randomly separate the data <span class="math inline">\(D\)</span> into <span class="math inline">\(K\)</span> (<code>Kfold</code>) non-overlapping parts of approximately equal sizes, <span class="math inline">\(D_1, \dots, D_K\)</span>.</p></li>
<li>
<p>For each fold <span class="math inline">\(k=1,\dots,K\)</span>, and separately by treatment group <span class="math inline">\(r \in \{0,1\}\)</span>:</p>
<p>2.1 Estimate the conditional mean outcome given baseline covariates and log-transformed exposure time as the offset with the Poisson-based gradient boosting regression method based on observations without the kth fold, <span class="math inline">\(D_{-k}\)</span>, and denote the prediction as <span class="math inline">\(\hat Y_{-k}^{(r)}(\boldsymbol{x},t)\)</span>. This is the initial nonparametric prediction of the potential outcome.</p>
<p>2.2 Estimate the PS based on <span class="math inline">\(D_{-k}\)</span>. Denote the estimated PS as <span class="math inline">\(\hat \pi_{-k}(\boldsymbol{x})\)</span>.</p>
</li>
<li><p>Solve the following doubly robust estimating equation by Newton-Raphson method or using a L2-norm score method if the former fails to converge: <span class="math display">\[\begin{aligned}
S(\boldsymbol{\delta})&amp;=\sum_{k=1}^K \sum_{i \in D_{-k}} \boldsymbol{\tilde x}\Bigg[\frac{R\left\{\frac{Y}{T}-\frac{1}{2}\left(\hat Y_{-k}^{(0)}(\boldsymbol{ x})\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x}) + \hat Y_{-k}^{(1)}(\boldsymbol{x})\right)\right\}(1-\hat\pi_{-k}(\boldsymbol{x}))}{\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x})\hat\pi_{-k}(\boldsymbol{x})+1-\hat\pi_{-k}(\boldsymbol{x})}\\
&amp;+\frac{(1-R)\left\{\frac{Y}{T}-\frac{1}{2}\left(\hat Y_{-k}^{(0)}(\boldsymbol{ x}) + \hat Y_{-k}^{(1)}(\boldsymbol{x})\text{exp}(-\boldsymbol{\delta^T}\boldsymbol{\tilde x})\right)\right\}\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x})\hat\pi_{-k}(\boldsymbol{x})}{\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x})\hat\pi_{-k}(\boldsymbol{x})+1-\hat\pi_{-k}(\boldsymbol{x})}\Bigg]=0
\end{aligned}\]</span> Denote the estimator as <span class="math inline">\(\boldsymbol{\hat\delta}\)</span>.</p></li>
<li><p>Repeat steps 1-3 with <span class="math inline">\(B\)</span> bootstrap samples and denote the estimator <span class="math inline">\(\boldsymbol{\hat \delta_b}\)</span> in the <span class="math inline">\(b\)</span> sample. The final estimator <span class="math inline">\(\boldsymbol{\hat \delta}\)</span> is the mean of the <span class="math inline">\(\boldsymbol{\hat \delta_b}\)</span>.</p></li>
<li><p>The CATE score with contrast regression is</p></li>
</ol>
<p><span class="math display">\[\hat{CATE}_{contrastreg}(\boldsymbol{x})=\boldsymbol{\hat \delta^T\tilde x}\]</span></p>
</div>
<div class="section level3">
<h3 id="validation-curves-and-the-abc-statistics">Validation curves and the ABC statistics<a class="anchor" aria-label="anchor" href="#validation-curves-and-the-abc-statistics"></a>
</h3>
<p>The ABC statistic represents the area between the validation curve and the ATE. For a single CV iteration, it is implemented in the training and validation sets separately as following:</p>
<p><strong>Step 1</strong>. Calculate the ATE in the training or validation sets.</p>
<p><strong>Step 2</strong>. Calculate the ATE in 100 nested subgroups based on the estimated CATE score and derive the corresponding validation curve. Subgroups are defined with 100 equally-spaced proportions from <code>min(prop.cutoff)</code> to <code>max(prop.cutoff)</code> to ensure that enough data points are available to build the validation curve.</p>
<p><strong>Step 3</strong>. The ABC is calculated with <code>auc()</code> from the MESS R package using the natural cubic spline interpolation, which calculates the area between the horizontal line with y-intercept at the ATE calculated in <strong>step 1</strong> over the range [<code>min(prop.cutoff)</code>,<code>max(prop.cutoff)</code>] (<em>y</em>) and the validation curve calculated in <strong>step 2</strong> (<em>x</em>).</p>
<p>The function <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> allows the user to combine validation curves from 2 or more CV iterations (i.e., <code>cv.n &gt; 1</code>). There are 2 ways to combine the validation curves:</p>
<ol style="list-style-type: decimal">
<li><p>The option <code>combine</code>=“median” takes the median of the ATEs across all CV iterations in <strong>step 1</strong> and the median of the ATEs in the 100 nested subgroups in <strong>step 2</strong>.</p></li>
<li><p>The option <code>combine</code>=“mean” takes the mean of the ATEs across all CV iterations in <strong>step 1</strong> and the mean of the ATEs in the 100 nested subgroups in <strong>step 2</strong>.</p></li>
</ol>
<p>In either case, the ABC calculations are carried out as in <strong>step 3</strong> with the resulting <em>x</em> and <em>y</em>.</p>
<p>The figure below explains how the ABC is calculated with a simple schema. The ABC calculations are such that larger positive ABC values always indicate more treatment effect heterogeneity. This is implemented by considering separately the cases when larger or smaller outcomes are preferred.</p>
<ul>
<li><p>If larger count outcomes are preferred (<code>higher.y = TRUE</code>, e.g., positive events like number of motor developmental milestones reached), a validation curve above the ATE line and decreasing towards that line is synonym with treatment effect heterogeneity (top left figure). However, sections of the validation curve below the ATE line indicate inability to capture treatment effect heterogeneity (bottom left figure). Hence, the ABC is defined by subtracting the areas below the ATE line (red) from the areas above the ATE line (green) such that larger positive ABC are preferred.</p></li>
<li><p>If smaller count outcomes are preferred (<code>higher.y = FALSE</code>, e.g., negative events like number of relapses), a validation curve below the ATE line and increasing towards that line is synonym with treatment effect heterogeneity (top right figure). However, sections of the validation curve above the ATE line indicate inability to capture treatment effect heterogeneity (bottom right figure). Hence, the ABC is defined by subtracting the areas above the ATE line (red) from the areas below the ATE line (green) such that larger positive ABC are preferred.</p></li>
</ul>
<p><img src="ABCexample.png"><!-- --></p>
<p>ABC calculation examples in relation with <code>higher.y</code> argument in <code><a href="../reference/catecv.html">catecv()</a></code> and <code><a href="../reference/catefit.html">catefit()</a></code>. Validation curves are represented with a blue line and the dashed line is the ATE</p>
</div>
</div>
<div class="section level2">
<h2 id="theoretical-details---survival-outcomes">Theoretical details - Survival outcomes<a class="anchor" aria-label="anchor" href="#theoretical-details---survival-outcomes"></a>
</h2>
<p>Assume that the following data are recorded for each of <span class="math inline">\(n\)</span> observations:</p>
<ul>
<li>
<span class="math inline">\(R\)</span> is a binary treatment taking value 0 or 1.</li>
<li>
<span class="math inline">\(\boldsymbol{X}\)</span> is a vector of <span class="math inline">\(p\)</span> baseline covariates.</li>
<li>
<span class="math inline">\(T\)</span> is a survival time.</li>
<li>
<span class="math inline">\(C\)</span> is a censoring time.</li>
<li>
<span class="math inline">\(Y\)</span> is the minimum between <span class="math inline">\(T\)</span> and <span class="math inline">\(C\)</span>.</li>
<li>
<span class="math inline">\(\delta\)</span> is an indicator taking value 1 if <span class="math inline">\(Y = T\)</span> and 0 otherwise.</li>
<li>
<span class="math inline">\(\tau\)</span> is a truncation time for restricted mean time lost.</li>
</ul>
<p>The objective is to estimate the ratio-based CATE score defined as</p>
<p><span class="math display">\[CATE(\boldsymbol{x})=\text{log}\left(\frac{\mathbb{E}[\tau - (T^{(1)} \wedge\tau)|\boldsymbol{X}=\boldsymbol{x}]}{\mathbb{E}[\tau - (T^{(0)} \wedge\tau)|\boldsymbol{X}=\boldsymbol{x}]}\right)\]</span></p>
<p>where <span class="math inline">\(T^{(r)}\)</span> is the potential survival time if the patient received the treatment <span class="math inline">\(r \in \{0,1\}\)</span>. <span class="math inline">\(CATE(\boldsymbol{x})\)</span> is interpreted as the individualized logarithm restricted mean time lost (RMTL) ratio of treatment 1 over treatment 0 conditional on the baseline covariates.</p>
<p>The package offers 5 methods to estimate the CATE score: Poisson regression, random forest, boosting, two regressions, and contrast regression.</p>
<div class="section level3">
<h3 id="poisson-1">Poisson<a class="anchor" aria-label="anchor" href="#poisson-1"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Estimate the conditional mean RMTL given baseline covariates separately in each treatment group (i.e., <span class="math inline">\(\text{log}(\mathbb{E}[\tau - T\wedge\tau|\boldsymbol{x}, r])=\beta_r \boldsymbol{\tilde x}\)</span> for <span class="math inline">\(r \in \{0,1\}\)</span> where <span class="math inline">\(\boldsymbol{\tilde x}\)</span> is the <span class="math inline">\(x\)</span> with an intercept) with Poisson regression weighted with IPCW. Denote the prediction as <span class="math inline">\(\hat Y^{(r)}(\boldsymbol{x})=\text{exp}(\hat \beta_r \boldsymbol{\tilde x})\)</span>.</p></li>
<li><p>The CATE score with Poisson is the plug-in estimator</p></li>
</ol>
<p><span class="math display">\[\widehat{CATE}_{Poisson}(\boldsymbol{x})=\text{log}\left(\frac{\hat Y^{(1)}(\boldsymbol{x})}{\hat Y^{(0)}(\boldsymbol{x})}\right) = (\hat \beta_1 - \hat \beta_0) \boldsymbol{\tilde x}\]</span></p>
</div>
<div class="section level3">
<h3 id="boosting-1">Boosting<a class="anchor" aria-label="anchor" href="#boosting-1"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Estimate the conditional mean RMTL given baseline covariates separately in each treatment group (i.e., <span class="math inline">\(\mathbb{E}[Y^{(r)}|\boldsymbol{x}]\)</span> for <span class="math inline">\(r \in \{0,1\}\)</span>) with Poisson-based gradient boosting regression method weighted with IPCW. Denote the prediction as <span class="math inline">\(\hat Y^{(r)}(\boldsymbol{x})\)</span>.</p>
<ul>
<li>The number of trees is specificed with the argument <code>n.trees.boosting</code>. Default is 200.</li>
<li>The depth of trees is specified with the argument <code>tree.depth</code>. Default is 2.</li>
</ul>
</li>
<li><p>The CATE score with boosting is the plug-in estimator</p></li>
</ol>
<p><span class="math display">\[\widehat{CATE}_{boosting}(\boldsymbol{x})=\text{log}\left(\frac{\hat Y^{(1)}(\boldsymbol{x})}{\hat Y^{(0)}(\boldsymbol{x})}\right)\]</span></p>
</div>
<div class="section level3">
<h3 id="random-forest">Random forest<a class="anchor" aria-label="anchor" href="#random-forest"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Estimate the conditional mean RMTL given baseline covariates separately in each treatment group (i.e., <span class="math inline">\(\mathbb{E}[Y^{(r)}|\boldsymbol{x}]\)</span> for <span class="math inline">\(r \in \{0,1\}\)</span>) with survival random forest. Denote the prediction as <span class="math inline">\(\hat Y^{(r)}(\boldsymbol{x})\)</span>.</p>
<ul>
<li>The number of trees in boosting is selected via CV with a maximum number of trees specificed with the argument <code>n.trees.rf</code>. Default is 1,000.</li>
<li>The base learners are regression trees with depth specified with the argument <code>tree.depth</code>. Default is 2.</li>
</ul>
</li>
<li><p>The CATE score with boosting is the plug-in estimator</p></li>
</ol>
<p><span class="math display">\[\widehat{CATE}_{boosting}(\boldsymbol{x})=\text{log}\left(\frac{\hat Y^{(1)}(\boldsymbol{x})}{\hat Y^{(0)}(\boldsymbol{x})}\right)\]</span></p>
</div>
<div class="section level3">
<h3 id="two-regressions-1">Two regressions<a class="anchor" aria-label="anchor" href="#two-regressions-1"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Randomly separate the data <span class="math inline">\(D\)</span> into <span class="math inline">\(K\)</span> (<code>Kfold</code>) non-overlapping parts of approximately equal sizes, <span class="math inline">\(D_1, \dots, D_K\)</span>.</p></li>
<li>
<p>For each fold <span class="math inline">\(k=1,\dots,K\)</span>, and separately by treatment arm <span class="math inline">\(r \in \{0,1\}\)</span>:</p>
<p>2.1 Estimate the conditional mean RMTL given baseline covariates with the Poisson-based gradient boosting regression method (<code>initial.predictor.method = "boosting"</code>) based on observations without the kth fold, <span class="math inline">\(D_{-k}\)</span>, and denote the prediction as <span class="math inline">\(\hat Y_{-k}^{(r)}(\boldsymbol{x})\)</span>. This is the initial nonparametric prediction of the potential outcome. Other methods can be used to generate an initial prediction (see <code>initial.predictor.method</code> argument).</p>
<p>2.2 Estimate the propensity score model based on <span class="math inline">\(D_{-k}\)</span>. Denote the estimated PS as <span class="math inline">\(\hat \pi_{-k}(\boldsymbol{x})\)</span> and estimate the weights <span class="math inline">\(\hat W_{-k}(r)=r\frac{R}{\hat \pi_{-k}(\boldsymbol{x})}+(1-r)\frac{(1-R)}{1-\hat \pi_{-k}(\boldsymbol{x})}\)</span> with <span class="math inline">\(R\)</span> denoting the treatment received.</p>
<p>2.3 Estimate the IPCW:</p>
<p><span class="math display">\[\hat L(r,y) = \frac{\delta+(1-\delta)I(y^{(r)}\geq\tau)}{\hat K_{C^{(r)}}(T \wedge \tau|x)}\]</span></p>
<p>where <span class="math inline">\(\hat K_{C^{(r)}}(T \wedge \tau|x)\)</span> is a consistent estimator of the survival function of the censoring time given the covariate <span class="math inline">\(x\)</span>, for example, using a Cox model and the Breslow estimator for the cumulative baseline hazard function (<code>ipcw.method = "breslow"</code>).</p>
<p>2.4 Solve the following weighted estimating equation by fitting a Poisson regression with <span class="math inline">\(\tau - (T\wedge\tau)\)</span> as the response, <span class="math inline">\(\text{log}(\hat Y_{-k}^{(r)}(\boldsymbol{x}))\)</span> and <span class="math inline">\(x\)</span> as the covariates, and <span class="math inline">\(\hat K(r,y)\times\hat W_{-k}(r)\)</span> as weight:</p>
<p><span class="math display">\[S(\alpha_{rk}, \boldsymbol{\gamma_{rk}})=\sum_{i \in D_{-k}} \hat K(r,y) \hat W_{-k}(r) \left((\tau- T\wedge\tau) - \text{exp}\left(\alpha_{rk}\text{log}
 \left(\hat Y_{-k}^{(r)}(\boldsymbol{x})\right)+\boldsymbol{\gamma_{rk}^T}\boldsymbol{\tilde x}\right)\right)=0\]</span></p>
</li>
<li><p>Solve the following doubly robust estimating equation by fitting a Poisson regression with <span class="math inline">\(\text{exp}\left(\hat\alpha_{rk}\text{log}\left(\hat Y_{-k}^{(r)}(\boldsymbol{x})\right)+\boldsymbol{\hat\gamma_{rk}^T\boldsymbol{\tilde x}}\right)\)</span> as the response, <span class="math inline">\(\boldsymbol{x}\)</span> as the covariates, and no offset or weight: <span class="math display">\[S(\boldsymbol{\beta_r})=\sum_{k=1}^K \sum_{i \in D_{k}}\boldsymbol{\tilde x}\left(\text{exp}\left(\hat\alpha_{rk}\text{log}\left(\hat Y_{-k}^{(r)}(\boldsymbol{x})\right)+\boldsymbol{\hat\gamma_{rk}^T\boldsymbol{\tilde x}}\right)-\text{exp}(\boldsymbol{\beta_r^T\tilde x})\right)=0\]</span> Denote the estimator as <span class="math inline">\(\boldsymbol{\hat \beta_r}\)</span>.</p></li>
<li><p>Repeat steps 1-3 with <span class="math inline">\(B\)</span> bootstrap samples (<code>B</code>) and denote the estimator <span class="math inline">\(\boldsymbol{\hat \beta_{rb}}\)</span> in the <span class="math inline">\(b\)</span> sample. The final estimator <span class="math inline">\(\boldsymbol{\hat \beta_r}\)</span> is the mean of the <span class="math inline">\(\boldsymbol{\hat \beta_{rb}}\)</span>.</p></li>
<li><p>The CATE score with two regression is</p></li>
</ol>
<p><span class="math display">\[\widehat{CATE}_{tworeg}(\boldsymbol{x})=(\boldsymbol{\hat \beta_1} - \boldsymbol{\hat \beta_0})^T\boldsymbol{\tilde x}\]</span></p>
</div>
<div class="section level3">
<h3 id="contrast-regression-1">Contrast regression<a class="anchor" aria-label="anchor" href="#contrast-regression-1"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Randomly separate the data <span class="math inline">\(D\)</span> into <span class="math inline">\(K\)</span> (<code>Kfold</code>) non-overlapping parts of approximately equal sizes, <span class="math inline">\(D_1, \dots, D_K\)</span>.</p></li>
<li>
<p>For each fold <span class="math inline">\(k=1,\dots,K\)</span>, and separately by treatment arm <span class="math inline">\(r \in \{0,1\}\)</span>:</p>
<p>2.1 Estimate the conditional mean RMTL given baseline covariates with the Poisson-based gradient boosting regression method (<code>initial.predictor.method = "boosting"</code>) based on observations without the kth fold, <span class="math inline">\(D_{-k}\)</span>, and denote the prediction as <span class="math inline">\(\hat Y_{-k}^{(r)}(\boldsymbol{x})\)</span>. This is the initial nonparametric prediction of the potential outcome. Other methods can be used to generate an initial prediction (see <code>initial.predictor.method</code> argument).</p>
<p>2.2 Estimate the propensity score model based on <span class="math inline">\(D_{-k}\)</span>. Denote the estimated PS as <span class="math inline">\(\hat \pi_{-k}(\boldsymbol{x})\)</span>.</p>
<p>2.3 Estimate the IPCW:</p>
<p><span class="math display">\[\hat L(r,y) = \frac{\delta+(1-\delta)I(y^{(r)}\geq\tau)}{\hat K_{C^{(r)}}(T \wedge \tau|x)}\]</span></p>
<p>where <span class="math inline">\(\hat K_{C^{(r)}}(T \wedge \tau|x)\)</span> is a consistent estimator of the survival function of the censoring time given the covariate <span class="math inline">\(x\)</span>, for example, using a Cox model and the Breslow estimator for the cumulative baseline hazard function (<code>ipcw.method = "breslow"</code>).</p>
</li>
<li><p>Solve the following doubly robust estimating equation by Newton-Raphson method or using a L2-norm score method if the former fails to converge: <span class="math display">\[\begin{aligned}
S(\boldsymbol{\delta})&amp;=\sum_{k=1}^K \sum_{i \in D_{k}} \hat L(r,y) \boldsymbol{\tilde x}\Bigg[\frac{R\left\{(\tau - T\wedge\tau)-\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x})\hat Y_{-k}^{(0)}(\boldsymbol{x})\right\}(1-\hat\pi_{-k}(\boldsymbol{x}))}{\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x})\hat\pi_{-k}(\boldsymbol{x})+1-\hat\pi_{-k}(\boldsymbol{x})}\\
&amp;-\frac{(1-R)\left\{(\tau - T\wedge\tau)-\hat Y_{-k}^{(0)}(\boldsymbol{ x}) \right\}\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x})\hat\pi_{-k}(\boldsymbol{x})}{\text{exp}(\boldsymbol{\delta^T}\boldsymbol{\tilde x})\hat\pi_{-k}(\boldsymbol{x})+1-\hat\pi_{-k}(\boldsymbol{x})}\Bigg]=0
\end{aligned}\]</span> Denote the estimator as <span class="math inline">\(\boldsymbol{\hat\delta}\)</span>.</p></li>
<li><p>Repeat steps 1-3 with <span class="math inline">\(B\)</span> bootstrap samples (<code>B</code>) and denote the estimator <span class="math inline">\(\boldsymbol{\hat \delta_b}\)</span> in the <span class="math inline">\(b\)</span> sample. The final estimator <span class="math inline">\(\boldsymbol{\hat \delta}\)</span> is the mean of the <span class="math inline">\(\boldsymbol{\hat \delta_b}\)</span>.</p></li>
<li><p>The CATE score with contrast regression is</p></li>
</ol>
<p><span class="math display">\[\widehat{CATE}_{contrastreg}(\boldsymbol{x})=\boldsymbol{\hat \delta^T\tilde x}\]</span></p>
</div>
<div class="section level3">
<h3 id="validation-curves-and-the-abc-statistics-1">Validation curves and the ABC statistics<a class="anchor" aria-label="anchor" href="#validation-curves-and-the-abc-statistics-1"></a>
</h3>
<p>The ABC statistic represents the area between the validation curve and the ATE. For a single CV iteration and a certain CATE score method, it is implemented as following in the training and validation sets separately:</p>
<p><strong>Step 1</strong>. Calculate the ATE in the training or validation sets.</p>
<p><strong>Step 2</strong>. Calculate the ATE in 100 nested subgroups and derive the corresponding validation curve. Subgroups are defined with 100 equally-spaced proportions from <code>min(prop.cutoff)</code> to <code>max(prop.cutoff)</code> to ensure that enough data points are available to build the validation curve.</p>
<p><strong>Step 3</strong>. The ABC is calculated with <code>auc()</code> from the MESS R package using the natural cubic spline interpolation, which calculates the area between the horizontal line with y-intercept at the ATE calculated in <strong>step 1</strong> (<em>y</em>) and the validation curve calculated in <strong>step 2</strong> (<em>x</em>) over the range [<code>min(prop.cutoff)</code>, <code>max(prop.cutoff)</code>].</p>
<p>The function <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> allows the user combining validation curves from 2 or more CV iterations (i.e., <code>cv.n &gt; 1</code>). There are 2 ways to combine the validation curves:</p>
<ol style="list-style-type: decimal">
<li><p>The option <code>combine ="median"</code> takes the median of the ATEs across all CV iterations in <strong>step 1</strong> and the median of the ATEs in the 100 nested subgroups in <strong>step 2</strong>.</p></li>
<li><p>The option <code>combine ="mean"</code> takes the mean of the ATEs across all CV iterations in <strong>step 1</strong> and the mean of the ATEs in the 100 nested subgroups in <strong>step 2</strong>.</p></li>
</ol>
<p>In either case, the ABC calculations are carried out as in <strong>step 3</strong> with the resulting <em>x</em> and <em>y</em>.</p>
<p>The figure below explains how the ABC is calculated with a simple schema. The ABC calculations are such that larger positive ABC values always indicate more treatment effect heterogeneity. This is implemented by considering separately the cases when larger or smaller outcomes are preferred.</p>
<ul>
<li><p>If smaller survival outcomes are preferred (<code>higher.y = FALSE</code>, e.g., time to a positive event like recovery), a validation curve above the ATE line which decreases towards it is synonym with treatment effect heterogeneity (top left figure). However, sections of the validation curve below the ATE line indicate inability to capture treatment effect heterogeneity (bottom left figure). Hence, the ABC is defined by subtracting the areas below the ATE line from the areas above the ATE line such that larger positive ABC are preferred.</p></li>
<li><p>If larger survival outcomes are preferred (<code>higher.y = TRUE</code>, e.g., time to a negative event like symptom onset), a validation curve (in blue) below the ATE line (dashed) which increases towards it is synonym with treatment effect heterogeneity (top right figure). However, sections of the validation curve above the ATE line indicate inability to capture treatment effect heterogeneity (bottom right figure). Hence, the ABC is defined by subtracting the areas above the ATE line (in red) from the areas below the ATE line (in green) such that larger positive ABC are preferred.</p></li>
</ul>
<p><img src="ABCexample_survival.png"><!-- --></p>
<p>ABC calculation examples in relation with <code>higher.y</code> argument in <code><a href="../reference/catecv.html">catecv()</a></code> and <code><a href="../reference/catefit.html">catefit()</a></code>. Validation curves are represented with a blue line and the dashed line is the ATE.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-precmed-vignettes-in-this-serie">Other <code>precmed</code> vignettes in this serie<a class="anchor" aria-label="anchor" href="#other-precmed-vignettes-in-this-serie"></a>
</h2>
<p><a href="precmed.html">1. General introduction</a><br><a href="Count-examples.html">2. Examples for count outcome</a><br><a href="Survival-examples.html">3. Examples for survival outcome</a><br><a href="Additional-examples.html">4. Additional examples</a><br><a href="Theoretical-details.html">5. Theoretical details</a></p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Lu Tian, Xiaotong Jiang, Gabrielle Simoneau, Thomas Debray.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
